# 4.5.2 Nginx组件/编译/bug解决方案/过滤器



## 组件

- 1.组件如何使用
- 2.过滤器模块实现

![image-20241018202757798](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018202757798.png)

![image-20241018203229895](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018203229895.png)

组件



nginx内部组件非常多，我们可**抽离**出：

- 内存池

- 线程池

- 共享内存

- 红黑树

- ngx_array_t

- ngx_list_t

- ngx_hash_t

- ngx_rbtree_t

- ngx_queue_t

- 原子操作

- 日志

- slab 共享内存组织方式

- ngx_str_t

- ```c
  typedef struct {
      size_t  len;
      u_char *data;
  } ngx_str_t;
  ```





问题：为什么要len？直接string不行吗？

答：nginx的字符串直接放到内存池中的，需要len来在内存池分配合适大小的内存



## 编译bug

ps：测试时怎么知道要加什么头文件？

- 看报错，一个一个加。 
- 先 -I链接库， 库没问题了再看报错
- 把缺少的头文件一个一个加在源文件中
- 链接库太多了换makefile/cmake
- 报错发现nginx存在内部定义但未实现函数，直接放到源文件开头

![image-20241018205803346](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018205803346.png)



## 



## **模块：**



nginx 将各功能模块组织成一条链，当有请求到达的时候，请求依次经过这条链上的部分或者全部模块进行处理。每个模块实现特定的功能。

Nginx模块分为两大类：**核心模块**和**第三方模块**。其中，核心模块由Nginx自身提供，而第三方模块则由开发者或者社区进行开发。模块可以根据其功能细分为几种类型：

1. **核心模块**：这些模块属于Nginx自带的核心部分，不可被卸载。例如基本的HTTP、TCP、UDP处理功能。
2. **HTTP模块**：这些模块用来处理HTTP协议的请求，比如反向代理、负载均衡等。用户可以自定义或加载HTTP模块来增强Nginx的HTTP处理能力。
3. **事件模块**：用于处理Nginx的事件驱动模型，决定Nginx如何处理并发请求和管理连接。
4. **负载均衡模块**：用于实现Nginx的负载均衡功能，通过不同的策略将流量分发到不同的后端服务器。
5. **过滤器模块**：这种模块用于过滤HTTP响应内容，例如对响应进行压缩、修改响应数据等。
6. **第三方模块**：开发者或社区编写的模块，用来扩展Nginx的功能。例如WAF（Web应用防火墙）模块、性能监控模块、日志分析模块等。

#### 模块的生命周期

每个Nginx模块在其整个生命周期内会经过不同的阶段：

1. **配置解析阶段**：Nginx启动或重载配置时，模块会参与配置文件的解析，读取用户定义的参数，并将它们存储在模块的配置结构中。
2. **初始化阶段**：在Nginx启动时，模块会进行必要的初始化工作，准备好数据结构，连接Nginx的核心框架，准备处理请求。
3. **请求处理阶段**：Nginx接收到用户请求后，模块会根据自身功能参与请求的处理。例如，过滤器模块会修改响应内容，反向代理模块会将请求转发到后端服务器等。
4. **资源释放阶段**：Nginx关闭时，模块会释放分配的资源，清理内存等。



1.新建两个文件

.config

.c

![image-20241018213503167](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018213503167.png)

config文件

![image-20241018213801518](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018213801518.png)



2.编译时执行

![image-20241018214026809](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018214026809.png)

![image-20241018214144929](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018214144929.png)

报错:

![image-20241018214424140](4.5.2%20Nginx%E8%BF%87%E6%BB%A4%E5%99%A8%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0.assets/image-20241018214424140.png)

### 过滤器模块





### handler模块



phase handler：包含若干个针对不同阶段的handler

一个 phase handler 通常执行以下几项任务：
1.获取 location 配置。
2.产生适当的响应。
3.发送 response header。
4.发送 response body。